---
- hosts: pfsense
  gather_facts: False
  vars:
    CERTIFICATE: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVDRENDQXZDZ0F3SUJBZ0lJRmpGT2hzMW5NelF3RFFZSktvWklodmNOQVFFTEJRQXdYREVUTUJFR0ExVUUKQXhNS2IzQmxiblp3YmkxallURUxN\
        QWtHQTFVRUJoTUNWVk14RVRBUEJnTlZCQWdUQ0VOdmJHOXlZV1J2TVJBdwpEZ1lEVlFRSEV3ZENiM1ZzWkdWeU1STXdFUVlEVlFRS0V3cHdabE5sYm5OcFlteGxNQjRYRFRJeU1ESXhOREExCk1EZ3pN\
        Vm9YRFRNeU1ESXhNakExTURnek1Wb3dYREVUTUJFR0ExVUVBeE1LYjNCbGJuWndiaTFqWVRFTE1Ba0cKQTFVRUJoTUNWVk14RVRBUEJnTlZCQWdUQ0VOdmJHOXlZV1J2TVJBd0RnWURWUVFIRXdkQ2Iz\
        VnNaR1Z5TVJNdwpFUVlEVlFRS0V3cHdabE5sYm5OcFlteGxNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDCkFRRUFtc3ZpSk1FMUVUZWQ0Zk90YmtIcEYzZDllTSs2NDA4WFBu\
        YTh0SkdkQnEzVUFDeEV6b2FCS1J0MnkxY3QKNnpRRGU1RkY0QUF2dFYxdWNacHNsNW80RFMvSUdTYm42ZDNZTWsrajhqQVEzRW16UjhHT29obmdmMVE5QVhDNgpvaDRyQlA1c1g0WTh1WThrSjNZclg1\
        cVRwRlk1S0hMVTFBb1BleVE3eXlNWkhMb2t0OW5jK0ZGWnd3VTdSQ0dTCmNOTFppVnhDUVFLNXA4azltQThiZ3hscVlrZjBtQXlCTnc5TUFmUFVjVWtxRjZQMGdXUEhsSXJIWi91aGc3ZFUKKzIyYW9j\
        S1VFTml2OW1xYStCNmNVZ0xURlQ2czBWU0VzWC9kQWVoNjJZTGdmbVhKZzZkTkhRSStNZzZTa2VscAprOVZSVGVqaUVUSUVWOEpnZHYyTjdSU201d0lEQVFBQm80SE5NSUhLTUIwR0ExVWREZ1FXQkJS\
        azVvQS8wcWEyCktQd2dvWEpxS010K0FvS0pnVENCalFZRFZSMGpCSUdGTUlHQ2dCUms1b0EvMHFhMktQd2dvWEpxS010K0FvS0oKZ2FGZ3BGNHdYREVUTUJFR0ExVUVBeE1LYjNCbGJuWndiaTFqWVRF\
        TE1Ba0dBMVVFQmhNQ1ZWTXhFVEFQQmdOVgpCQWdUQ0VOdmJHOXlZV1J2TVJBd0RnWURWUVFIRXdkQ2IzVnNaR1Z5TVJNd0VRWURWUVFLRXdwd1psTmxibk5wCllteGxnZ2dXTVU2R3pXY3pOREFNQmdO\
        VkhSTUVCVEFEQVFIL01Bc0dBMVVkRHdRRUF3SUJCakFOQmdrcWhraUcKOXcwQkFRc0ZBQU9DQVFFQVVIOUtDZG1KZG9BSmxVMHdCSkhZeGpMcktsbFBZNk9OYnpyNUpiaENNNjlIeHhZTgpCa2lpbXd1\
        N09mRmFGZkZDT25NSjhvcStKVGxjMG9vREoxM2xCdHRONkdybnZrUTNQMXdZYkNFTmJuaWxPYVVCClRJcmlIeXRORFFhb3VOYS9LV3M3RmF1b2JjdEJsMXc5YXRvSFpzTjVvZWhUM3JBVHYxQ0NBdGpw\
        YVRKSWZKUjMKMElRT1lrZTRvWTZEa0l3SHAydlBQbW9vR2dJdGJUdzNVK0U0MVlaZTdxQ21FLzd6TFRTWmtJTTJseDZ6RDQ2agpEZjRyZ044TVVMNnhpd09MbzlyQUp5ckRNM2JEeTJ1QjY0QkVzRFFM\
        a2huUE92ZWtETjQ1NnV6TmpYS0E3VnE4CmgxL2d6RFpJRGkrV1hDWUFjYmdMaFpWQnF0bjYydW1GcE1SSXV3PT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
    CRTDEC: |
        -----BEGIN CERTIFICATE-----
        MIIECDCCAvCgAwIBAgIIFjFOhs1nMzQwDQYJKoZIhvcNAQELBQAwXDETMBEGA1UE
        AxMKb3BlbnZwbi1jYTELMAkGA1UEBhMCVVMxETAPBgNVBAgTCENvbG9yYWRvMRAw
        DgYDVQQHEwdCb3VsZGVyMRMwEQYDVQQKEwpwZlNlbnNpYmxlMB4XDTIyMDIxNDA1
        MDgzMVoXDTMyMDIxMjA1MDgzMVowXDETMBEGA1UEAxMKb3BlbnZwbi1jYTELMAkG
        A1UEBhMCVVMxETAPBgNVBAgTCENvbG9yYWRvMRAwDgYDVQQHEwdCb3VsZGVyMRMw
        EQYDVQQKEwpwZlNlbnNpYmxlMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKC
        AQEAmsviJME1ETed4fOtbkHpF3d9eM+6408XPna8tJGdBq3UACxEzoaBKRt2y1ct
        6zQDe5FF4AAvtV1ucZpsl5o4DS/IGSbn6d3YMk+j8jAQ3EmzR8GOohngf1Q9AXC6
        oh4rBP5sX4Y8uY8kJ3YrX5qTpFY5KHLU1AoPeyQ7yyMZHLokt9nc+FFZwwU7RCGS
        cNLZiVxCQQK5p8k9mA8bgxlqYkf0mAyBNw9MAfPUcUkqF6P0gWPHlIrHZ/uhg7dU
        +22aocKUENiv9mqa+B6cUgLTFT6s0VSEsX/dAeh62YLgfmXJg6dNHQI+Mg6Skelp
        k9VRTejiETIEV8Jgdv2N7RSm5wIDAQABo4HNMIHKMB0GA1UdDgQWBBRk5oA/0qa2
        KPwgoXJqKMt+AoKJgTCBjQYDVR0jBIGFMIGCgBRk5oA/0qa2KPwgoXJqKMt+AoKJ
        gaFgpF4wXDETMBEGA1UEAxMKb3BlbnZwbi1jYTELMAkGA1UEBhMCVVMxETAPBgNV
        BAgTCENvbG9yYWRvMRAwDgYDVQQHEwdCb3VsZGVyMRMwEQYDVQQKEwpwZlNlbnNp
        YmxlgggWMU6GzWczNDAMBgNVHRMEBTADAQH/MAsGA1UdDwQEAwIBBjANBgkqhkiG
        9w0BAQsFAAOCAQEAUH9KCdmJdoAJlU0wBJHYxjLrKllPY6ONbzr5JbhCM69HxxYN
        Bkiimwu7OfFaFfFCOnMJ8oq+JTlc0ooDJ13lBttN6GrnvkQ3P1wYbCENbnilOaUB
        TIriHytNDQaouNa/KWs7FauobctBl1w9atoHZsN5oehT3rATv1CCAtjpaTJIfJR3
        0IQOYke4oY6DkIwHp2vPPmooGgItbTw3U+E41YZe7qCmE/7zLTSZkIM2lx6zD46j
        Df4rgN8MUL6xiwOLo9rAJyrDM3bDy2uB64BEsDQLkhnPOvekDN456uzNjXKA7Vq8
        h1/gzDZIDi+WXCYAcbgLhZVBqtn62umFpMRIuw==
        -----END CERTIFICATE-----
    CRL1: "LS0tLS1CRUdJTiBYNTA5IENSTC0tLS0tCk1JSUNkRENDQVZ3Q0FRRXdEUVlKS29aSWh2Y05BUUVGQlFBd1hERVRNQkVHQTFVRUF4TUtiM0JsYm5ad2JpMWoKWVRFTE1Ba0dBMVVFQmhNQ1ZWTXhFVEFQ\
        QmdOVkJBZ1RDRU52Ykc5eVlXUnZNUkF3RGdZRFZRUUhFd2RDYjNWcwpaR1Z5TVJNd0VRWURWUVFLRXdwd1psTmxibk5wWW14bEZ3MHlNakF5TVRrd05UVXhNRFphRncwME9UQTNNRFl3Ck5UVXhNRFph\
        TUNrd0p3SUlMdnhrNzExMkdwUVhEVEl5TURJeE9UQTFOVEV3TWxvd0REQUtCZ05WSFJVRUF3b0IKQmFDQm9EQ0JuVENCalFZRFZSMGpCSUdGTUlHQ2dCUms1b0EvMHFhMktQd2dvWEpxS010K0FvS0pn\
        YUZncEY0dwpYREVUTUJFR0ExVUVBeE1LYjNCbGJuWndiaTFqWVRFTE1Ba0dBMVVFQmhNQ1ZWTXhFVEFQQmdOVkJBZ1RDRU52CmJHOXlZV1J2TVJBd0RnWURWUVFIRXdkQ2IzVnNaR1Z5TVJNd0VRWURW\
        UVFLRXdwd1psTmxibk5wWW14bGdnZ1cKTVU2R3pXY3pOREFMQmdOVkhSUUVCQUlDSnhFd0RRWUpLb1pJaHZjTkFRRUZCUUFEZ2dFQkFGbXJ5cFUxU3p5dApNUUZCRWFZZk9waVpqRVhVajE5MVZuWENl\
        b0tNMk83bVUzYW5HVXRZQUJMcG15dmN2YnU2ZkJCVEtYSTFEb0VvClJkV1VDTVMxbk5BTWwyU0N0ZmJ5RHNHNjZHczRiNnRZeXE1SW5LVFJJdldUeU5vS0JiUHc1OHZYV0ljNmVmUXgKSTYvZSt4U3di\
        eE9MSFlRdGd4WTJOdk9xVGVnVE0rTHpIcmNJWmFPS09NbHNodTA4ajgzSnUxR0ttYlBKME1jZwpyVXNiYXRKcURUdWtQMi9VbmI0N1hwN21qUHVTY0Z5MjN2RGl2OHdvcjBYOEFSQW1ibTN4N2ZKeTlt\
        V2d1OVhMCmpNV1lxN1BEaXhwWElqTVdhZzN2bVYxOC9IdDIybW1xS1RPM3prVnJLUDA1TEhCNVloM2ZZcEpWdEhkeENlTzUKdmlvbU53SzA3QUE9Ci0tLS0tRU5EIFg1MDkgQ1JMLS0tLS0="
    CRL2: |
        -----BEGIN X509 CRL-----
        MIICSDCCATACAQEwDQYJKoZIhvcNAQEFBQAwXDETMBEGA1UEAxMKb3BlbnZwbi1j
        YTELMAkGA1UEBhMCVVMxETAPBgNVBAgTCENvbG9yYWRvMRAwDgYDVQQHEwdCb3Vs
        ZGVyMRMwEQYDVQQKEwpwZlNlbnNpYmxlFw0yMzAxMDcyMzIzMDNaFw01MDA1MjQy
        MzIzMDNaoIGfMIGcMIGNBgNVHSMEgYUwgYKAFGTmgD/SprYo/CChcmooy34CgomB
        oWCkXjBcMRMwEQYDVQQDEwpvcGVudnBuLWNhMQswCQYDVQQGEwJVUzERMA8GA1UE
        CBMIQ29sb3JhZG8xEDAOBgNVBAcTB0JvdWxkZXIxEzARBgNVBAoTCnBmU2Vuc2li
        bGWCCBYxTobNZzM0MAoGA1UdFAQDAgECMA0GCSqGSIb3DQEBBQUAA4IBAQAxhuDn
        A7SJl760tXhQFSWMKTn7VndhiR86GRJzS8H3uyfRqesGrUIcVFlN+z6XqHsJsann
        +/fPvCf5Oo0+R5o4NDpByx5CO0mAy0WReds4bykoSKVUJXEVFXNHl14+Emh6mJtP
        m/Uzzq4cKEtAxZdqd9tbaTwTh4NbH1C7RmbUgRKjWma4CiC1Sofo5mIhx5cCv+ng
        Ny5w9dLF4s+6qFXjvfYmQ0FyeRcltUoF3kTabS1WCdkGjsUSeGHBFLM4NH2mJPMR
        0yfIGdipSonSTF51ICqgoUGAYPqObvlQZDMjFF+GFL3LNQ7gO+1R1OMMKAZ+96nX
        gwt+00UVYhQCCZ3k
        -----END X509 CRL-----
  tasks:
    - name: test creation of a new ca
      pfsensible.core.pfsense_ca:
        name: ca1
        certificate: "{{ CRTDEC }}"

    - name: test creation of a new ca with crl
      pfsensible.core.pfsense_ca:
        name: ca1
        certificate: "{{ CERTIFICATE }}"
        crl: "{{ CRL1 }}"

    - name: test adding a CRL
      pfsensible.core.pfsense_ca:
        name: ca1
        certificate: "{{ CERTIFICATE }}"
        crl: "{{ CRL2 }}"

    - name: test update noop
      pfsensible.core.pfsense_ca:
        name: ca1
        certificate: "{{ CERTIFICATE }}"

    - name: test update serial
      pfsensible.core.pfsense_ca:
        name: ca1
        certificate: "{{ CERTIFICATE }}"
        serial: 10
        #command="update ca 'testdel' set trust=none, randomserial=none, serial='10'")

    - name: test update trust
      pfsensible.core.pfsense_ca:
        name: ca1
        certificate: "{{ CERTIFICATE }}"
        trust: True

    - name: Test removing ca
      pfsensible.core.pfsense_ca:
        name: ca1
        state: absent

    ##############
    # misc
    #
#    def test_create_ca_invalid_serial(self):
#        """ test creation of a new ca with invalid serial """
#        obj = dict(name='ca1', certificate=CERTIFICATE, serial=-1)
#        self.do_module_test(obj, failed=True, msg='serial must be greater than 0')
#
#    def test_delete_nonexistent_ca(self):
#        """ test deletion of an nonexistent ca """
#        obj = dict(name='noca')
#        self.do_module_test(obj, commmand=None, state='absent', changed=False)
